version: 2.1

description: "If you're running this bad things happened"

commands:
  start:
    description: "Save information about the job enviroment as artifacts to inspect later"
    parameters:
      data-dir:
        type: string
        default: "~/.ccidiag"
    steps:
      - run: 
          name: CircleCI Diag
          command: |
            mkdir << parameters.data-dir >> || true
            cat /proc/cpuinfo > << parameters.data-dir >>/proc_cpuinfo.log || true
            dpkg -l > << parameters.data-dir >>/dpkg.log || true
            yarn list > << parameters.data-dir >>/yarn.log || true
            brew list --versions > << parameters.data-dir >>/brew.log || true
            yarn global list > << parameters.data-dir >>/yarn-global.log || true
            gem query --local > << parameters.data-dir >>/gem.log || true
            npm --version || true
            npm ls --global > << parameters.data-dir >>/npm-global.log || true
            npm ls > << parameters.data-dir >>/npm.log || true
      - store_artifacts:
            path: << parameters.data-dir >>
            destination: ccidiag


